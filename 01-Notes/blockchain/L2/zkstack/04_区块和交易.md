# zkSync Era åŒºå—ä¸äº¤æ˜“

> ğŸ“– **æœ¬æ–‡æ¡£æ˜¯ zkSync Era Core æŠ€æœ¯åˆ†äº«æŠ¥å‘Šçš„ç¬¬å››éƒ¨åˆ†**
>
> æ·±å…¥è§£æ zkSync Era çš„åŒºå—ç»“æ„ã€æ‰¹æ¬¡ç”Ÿæˆæœºåˆ¶ã€äº¤æ˜“ç”Ÿå‘½å‘¨æœŸã€è´¹ç”¨æ¨¡å‹ä»¥åŠæœ€ç»ˆæ€§ä¿è¯ã€‚
>
> **å‰ç½®é˜…è¯»**ï¼š
>
> - [01_æ€»ä½“æ¶æ„](./01_æ€»ä½“æ¶æ„.md) - äº†è§£æ•´ä½“è®¾è®¡ç†å¿µ
> - [02_æ ¸å¿ƒæ¨¡å—åˆ†æ](./02_æ ¸å¿ƒæ¨¡å—åˆ†æ.md) - æŒæ¡æ¨¡å—å…³è”å…³ç³»  
> - [03_æ ¸å¿ƒç»„ä»¶](./03_æ ¸å¿ƒç»„ä»¶.md) - EraVMã€Proverã€ç³»ç»Ÿåˆçº¦ç­‰
>
> **åç»­é˜…è¯»**ï¼š
>
> - [05_ä¼ä¸šçº§éšç§åŒºå—é“¾](./05_Prividium.md) - Prividium ç§æœ‰é“¾ä»‹ç»
> - [06_Prividiumç§æœ‰é“¾æ­å»º](./06_Prividiumç§æœ‰é“¾æ­å»º.md) - æ­å»º Prividium ç§æœ‰é“¾

---

## ğŸ“¦ 1. åŒºå—ç»“æ„ä¸åˆ›å»ºï¼Œæ‰¹æ¬¡ç”Ÿæˆ

### 1.1 Miniblockï¼ˆL2 åŒºå—ï¼‰ç»“æ„

zkSync Era çš„ L2 åŒºå—ç§°ä¸º **Miniblock**ï¼Œæ˜¯äº¤æ˜“æ‰§è¡Œçš„åŸºæœ¬å•ä½ï¼š

#### ğŸ”§ æ ¸å¿ƒå­—æ®µ

| å­—æ®µ | ç±»å‹ | æè¿° |
|------|------|------|
| `blockNumber` | `uint64` | L2 åŒºå—å·ï¼Œå•è°ƒé€’å¢ |
| `timestamp` | `uint64` | åŒºå—æ—¶é—´æˆ³ |
| `txs[]` | `Transaction[]` | åŒ…å«çš„äº¤æ˜“åˆ—è¡¨ |
| `logsRoot` | `bytes32` | äº¤æ˜“æ—¥å¿—çš„ Merkle æ ¹ |
| `stateRoot` | `bytes32` | æ‰§è¡Œåçš„çŠ¶æ€æ ¹ |
| `commitment` | `bytes32` | åŒºå—æ‰¿è¯ºå“ˆå¸Œ |
| `l1BatchNumber` | `uint32` | æ‰€å± L1 æ‰¹æ¬¡å· |
| `gasUsed` | `uint256` | æ¶ˆè€—çš„ Gas æ€»é‡ |

#### ğŸ—ï¸ åˆ›å»ºæµç¨‹

```mermaid
flowchart TD
    A[Mempool äº¤æ˜“æ± ] --> B[Sequencer é€‰æ‹©äº¤æ˜“]
    B --> C[StateKeeper åˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒ]
    C --> D[Bootloader æ‰¹é‡æ‰§è¡Œ]
    D --> E[EraVM é€ç¬”å¤„ç†]
    E --> F[Witness Tracer è®°å½•è½¨è¿¹]
    F --> G[çŠ¶æ€æ›´æ–° & æ—¥å¿—ç”Ÿæˆ]
    G --> H[è®¡ç®— stateRoot & logsRoot]
    H --> I[ç”Ÿæˆ Miniblock]
    
    style A fill:#e1f5fe
    style I fill:#c8e6c9
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **äº¤æ˜“é€‰æ‹©**ï¼šSequencer æ ¹æ®ä¼˜å…ˆçº§ã€gas ä»·æ ¼ã€è´¦æˆ· nonce ç­‰ä» Mempool é€‰å–äº¤æ˜“
2. **æ‰§è¡Œç¯å¢ƒåˆå§‹åŒ–**ï¼šState Keeper è®¾ç½®åŒºå—ä¸Šä¸‹æ–‡ï¼ˆæ—¶é—´æˆ³ã€åŒºå—å·ç­‰ï¼‰
3. **æ‰¹é‡æ‰§è¡Œ**ï¼šBootloader åœ¨å—æ§ç¯å¢ƒä¸‹è°ƒç”¨ EraVM æ‰§è¡Œäº¤æ˜“
4. **çŠ¶æ€è¿½è¸ª**ï¼šWitness Tracer è®°å½•æ¯ç¬”äº¤æ˜“çš„çŠ¶æ€å˜æ›´å’Œæ‰§è¡Œè½¨è¿¹
5. **æ ¹è®¡ç®—**ï¼šåŸºäºçŠ¶æ€å˜æ›´è®¡ç®—æ–°çš„ `stateRoot` å’Œ `logsRoot`
6. **åŒºå—å°è£…**ï¼šå°†æ‰€æœ‰ä¿¡æ¯å°è£…ä¸ºå®Œæ•´çš„ Miniblock

> **æ³¨æ„**ï¼šé€šå¸¸æ²¡æœ‰äº¤æ˜“æ—¶ä¸ä¼šäº§ç”Ÿ Miniblockï¼›å‡ºå—ç­–ç•¥å¯é…ç½®ï¼ˆæ—¶é—´å¿ƒè·³æˆ–æŒ‰éœ€ï¼‰ã€‚

### 1.2 Batchï¼ˆL1 æ‰¹æ¬¡ï¼‰ç”Ÿæˆä¸æäº¤

#### ğŸ“Š æ‰¹æ¬¡èšåˆæœºåˆ¶

å¤šä¸ª Miniblocks ä¼šè¢«èšåˆæˆä¸€ä¸ª **L1 Batch** è¿›è¡Œé“¾ä¸Šæäº¤ã€‚Batch åŒ…å«çš„æ˜¯çŠ¶æ€å·®å¼‚ï¼ˆstate diffsï¼‰è€Œä¸æ˜¯åŸå§‹äº¤æ˜“æ•°æ®ï¼š

#### ğŸ—‚ï¸ L1 Batch ç»“æ„

åŸºäº zkSync Era çš„ `CommitBatchInfo` ç»“æ„ä½“ï¼ŒL1 Batch åŒ…å«ä»¥ä¸‹å®Œæ•´å­—æ®µï¼š

| å­—æ®µ | æè¿° | ç¤ºä¾‹å€¼ |
|------|------|--------|
| `batchNumber` | L1 æ‰¹æ¬¡ç¼–å· | `42` |
| `timestamp` | æ‰¹æ¬¡æ—¶é—´æˆ³ | `1699123456` |
| `numberOfLayer1Txs` | L1â†’L2 äº¤æ˜“æ•°é‡ | `5` |
| `newStateRoot` | æ–°çŠ¶æ€æ ¹ | `0xabcd...` |
| `indexRepeatedStorageChanges` | é‡å¤å­˜å‚¨å˜æ›´ç´¢å¼• | `1024` |
| `priorityOperationsHash` | ä¼˜å…ˆæ“ä½œå“ˆå¸Œ | `0x1234...` |
| `bootloaderHeapInitialContentsHash` | Bootloader å †åˆå§‹å†…å®¹å“ˆå¸Œ | `0x5678...` |
| `eventsQueueStateHash` | äº‹ä»¶é˜Ÿåˆ—çŠ¶æ€å“ˆå¸Œ | `0x9abc...` |
| `systemLogs` | ç³»ç»Ÿæ—¥å¿—æ•°æ® | `0xdef0...` |
| `totalL2ToL1Pubdata` | L2â†’L1 å…¬å…±æ•°æ®ï¼ˆçŠ¶æ€å·®å¼‚ï¼‰ | `0x1234...` |

> **æ³¨æ„**ï¼šæ­¤ç»“æ„åŸºäº zkSync Era æœ€æ–°å®ç°ï¼ŒåŒ…å«äº†å®Œæ•´çš„ `CommitBatchInfo` å­—æ®µã€‚

```mermaid
graph LR
    subgraph "L2 Layer"
        MB1[Miniblock 1<br/>Txs: 50<br/>State Changes: Î”1]
        MB2[Miniblock 2<br/>Txs: 75<br/>State Changes: Î”2]
        MB3[Miniblock 3<br/>Txs: 25<br/>State Changes: Î”3]
    end
    
    subgraph "Batch Aggregation"
        BA[L1 Batch<br/>State Diffs: Î”1+Î”2+Î”3<br/>Pubdata: 128KB<br/>Commitment: Hash]
    end
    
    subgraph "Off-chain Processing"
        P[Prover System<br/>åŸºäºæ‰§è¡Œ trace<br/>ç”Ÿæˆ ZK è¯æ˜]
    end
    
    subgraph "L1 Layer"
        CC[Commit Contract<br/>å­˜å‚¨çŠ¶æ€å·®å¼‚ & æ‰¿è¯º]
        PC[Prove Contract<br/>éªŒè¯ ZK è¯æ˜]
        EC[Execute Contract<br/>æ‰§è¡Œ Batch å¹¶æœ€ç»ˆç¡®è®¤]
    end
    
    MB1 --> BA
    MB2 --> BA
    MB3 --> BA
    BA --> CC
    BA -.-> P
    P --> PC
    CC --> EC
    PC --> EC
    
    style BA fill:#fff3e0
    style P fill:#e3f2fd
    style CC fill:#fff9c4
    style PC fill:#e8f5e8
    style EC fill:#fce4ec
```

#### ğŸ¯ å°é—­æ¡ä»¶

Batch åœ¨æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ—¶å°é—­ï¼š

| æ¡ä»¶ç±»å‹ | é˜ˆå€¼ | è¯´æ˜ |
|----------|------|------|
| **æ—¶é—´é™åˆ¶** | ~1-10 åˆ†é’Ÿ | ç¡®ä¿åŠæ—¶æ€§ï¼Œé¿å…ç”¨æˆ·ç­‰å¾…è¿‡ä¹… |
| **äº¤æ˜“æ•°é‡** | ~1000-5000 ç¬” | å¹³è¡¡ååé‡ä¸å¤„ç†æ•ˆç‡ |
| **Gas æ¶ˆè€—** | ~30-50M gas | æ§åˆ¶è®¡ç®—å¤æ‚åº¦ |
| **Pubdata å¤§å°** | ~128KB | å— L1 æ•°æ®å¯ç”¨æ€§æˆæœ¬é™åˆ¶ |
| **ä¼˜å…ˆé˜Ÿåˆ—** | æœ‰å¾…å¤„ç†é¡¹ | ç¡®ä¿ L1â†’L2 äº¤æ˜“åŠæ—¶å¤„ç† |

#### ğŸš€ L1 æäº¤æµç¨‹

```mermaid
sequenceDiagram
    participant BA as Batch Aggregation
    participant CC as Commit Contract
    participant P as Prover System
    participant PC as Prove Contract  
    participant EC as Execute Contract
    participant V as Verifier Contract
    participant U as Users
    
    Note over BA: Batch å°é—­ï¼ˆçŠ¶æ€å·®å¼‚èšåˆï¼‰
    Note over P: å¹¶è¡Œï¼šåŸºäºæ‰§è¡Œ trace<br/>ç”Ÿæˆ ZK è¯æ˜
    
    rect rgb(240, 248, 255)
        Note over CC, EC: L1 Layer - ä¸‰é˜¶æ®µå¤„ç†
        
        rect rgb(255, 243, 224)
            Note over CC: é˜¶æ®µ 1: Commit
            BA->>CC: commitBatches(pubdata, commitment)
            Note over CC: å­˜å‚¨çŠ¶æ€å·®å¼‚ & æ‰¿è¯º
        end
        
        rect rgb(227, 242, 253)
            Note over PC: é˜¶æ®µ 2: Prove
            P->>PC: proveBatches(proof)
            PC->>V: è°ƒç”¨éªŒè¯åˆçº¦
            V-->>PC: è¯æ˜éªŒè¯ç»“æœ
            Note over PC: è¯æ˜éªŒè¯é€šè¿‡
        end
        
        rect rgb(252, 228, 236)
            Note over EC: é˜¶æ®µ 3: Execute
            Note over EC: å‰ç½®æ¡ä»¶ï¼šCommit + Prove å®Œæˆ
            BA->>EC: executeBatches()
            Note over EC: æ›´æ–°çŠ¶æ€æ ¹<br/>å¤„ç†ææ¬¾/æ¶ˆæ¯<br/>æ ‡è®° Batch ä¸ºå·²æ‰§è¡Œ
        end
    end
    
    EC-->>U: ææ¬¾å¯é¢†å–
    EC-->>U: L2â†’L1 æ¶ˆæ¯ç”Ÿæ•ˆ
```

#### ğŸ”„ ä¸‰é˜¶æ®µè¯¦ç»†è¯´æ˜

| é˜¶æ®µ | æ‰§è¡Œè€… | åˆçº¦è°ƒç”¨ | ä¸»è¦åŠŸèƒ½ | æ•°æ®æ¥æº | çŠ¶æ€å˜åŒ– |
|------|--------|----------|----------|----------|----------|
| **Commit** | Batch Aggregation | `commitBatches()` | â€¢ æäº¤ `CommitBatchInfo` åˆ° L1<br/>â€¢ å­˜å‚¨ `newStateRoot` å’Œæ‰¹æ¬¡å…ƒæ•°æ®<br/>â€¢ è®°å½• `totalL2ToL1Pubdata` | L2 çŠ¶æ€å·®å¼‚å’Œç³»ç»Ÿæ—¥å¿— | `Committed` |
| **Prove** | Prover System | `proveBatches()` | â€¢ æäº¤ ZK è¯æ˜<br/>â€¢ L1 éªŒè¯è®¡ç®—æ­£ç¡®æ€§<br/>â€¢ æ›´æ–°è¯æ˜çŠ¶æ€ | åŸºäºæ‰§è¡Œ trace ç”Ÿæˆçš„è¯æ˜ | `Proven` |
| **Execute** | Batch Aggregation | `executeBatches()` | â€¢ æ›´æ–° L1 çŠ¶æ€æ ¹<br/>â€¢ å¤„ç†ææ¬¾è¯·æ±‚<br/>â€¢ æ‰§è¡Œè·¨å±‚æ¶ˆæ¯ | Commit + Prove ç»“æœ | `Executed` |

---

## ğŸ”„ 2. äº¤æ˜“ç±»å‹ä¸ç”Ÿå‘½å‘¨æœŸ

### 2.1 äº¤æ˜“åˆ†ç±»

#### ğŸ“‹ äº¤æ˜“ç±»å‹æ¦‚è§ˆ

```mermaid
mindmap
  root((zkSync Era äº¤æ˜“))
    æ™®é€š L2 äº¤æ˜“
      ç”¨æˆ·è½¬è´¦
      åˆçº¦è°ƒç”¨
      ä»£å¸æ“ä½œ
    L1â†’L2 ä¼˜å…ˆäº¤æ˜“
      å­˜æ¬¾äº¤æ˜“
      å¼ºåˆ¶åŒ…å«
      è·¨å±‚æ¶ˆæ¯
    ç³»ç»Ÿäº¤æ˜“
      åè®®å‡çº§
      ç³»ç»Ÿç»´æŠ¤
      æ‰¹æ¬¡å¤„ç†
    è´¦æˆ·æŠ½è±¡äº¤æ˜“
      åˆçº¦è´¦æˆ·
      Paymaster ä»£ä»˜
      ç­¾åèšåˆ
      å¤šç­¾æ“ä½œ
```

#### ğŸ” è¯¦ç»†è¯´æ˜

| äº¤æ˜“ç±»å‹ | æ¥æº | ç‰¹ç‚¹ | ç¤ºä¾‹ |
|----------|------|------|------|
| **æ™®é€š L2 äº¤æ˜“** | ç”¨æˆ· RPC æäº¤ | ç”± Sequencer æ’åºï¼Œå¯è¢«é‡æ’ | ETH è½¬è´¦ã€ERC20 æ“ä½œã€DeFi äº¤äº’ |
| **L1â†’L2 ä¼˜å…ˆäº¤æ˜“** | L1 åˆçº¦è§¦å‘ | è¿›å…¥ä¼˜å…ˆé˜Ÿåˆ—ï¼Œå¢å¼ºæŠ—å®¡æŸ¥æ€§ | å­˜æ¬¾ã€å¼ºåˆ¶ææ¬¾ã€è·¨é“¾æ¶ˆæ¯ |
| **ç³»ç»Ÿäº¤æ˜“** | åè®®å†…éƒ¨ | ç»´æŠ¤ç³»ç»ŸçŠ¶æ€ï¼Œä¼˜å…ˆçº§æœ€é«˜ | å‡çº§æ‰§è¡Œã€è´¹ç”¨æ”¶é›†ã€æ¸…ç†æ“ä½œ |
| **è´¦æˆ·æŠ½è±¡äº¤æ˜“** | åˆçº¦è´¦æˆ· | è‡ªå®šä¹‰éªŒè¯é€»è¾‘ï¼Œæ”¯æŒä»£ä»˜ | ç¤¾äº¤æ¢å¤ã€æ‰¹é‡æ“ä½œã€gasless äº¤æ˜“ |

### 2.2 äº¤æ˜“ç”Ÿå‘½å‘¨æœŸè¯¦è§£

#### ğŸ”„ çŠ¶æ€è½¬æ¢å›¾

```mermaid
stateDiagram-v2
    [*] --> Received: ç”¨æˆ·æäº¤
    Received --> Validated: åŸºç¡€éªŒè¯
    Validated --> Queued: è¿›å…¥ Mempool
    Queued --> Sequenced: Sequencer é€‰æ‹©
    Sequenced --> Executing: Bootloader æ‰§è¡Œ
    Executing --> Executed: EraVM å®Œæˆ
    Executed --> Included: å†™å…¥ Miniblock
    Included --> Committed: Batch æäº¤ L1
    Committed --> Proved: ZK è¯æ˜éªŒè¯
    Proved --> Finalized: L1 æ‰§è¡Œç¡®è®¤
    
    Validated --> Rejected: éªŒè¯å¤±è´¥
    Executing --> Failed: æ‰§è¡Œå¤±è´¥
    Rejected --> [*]
    Failed --> [*]
    
    note right of Included: L2 è½¯ç¡®è®¤<br/>ç”¨æˆ·å¯è§
    note right of Committed: æ•°æ®å¯ç”¨æ€§<br/>ä¿è¯
    note right of Proved: å®‰å…¨æ€§<br/>ä¿è¯
    note right of Finalized: æœ€ç»ˆç¡®è®¤<br/>ä¸å¯å›æ»š
```

#### ğŸ“Š å„é˜¶æ®µè¯¦ç»†è¯´æ˜

| é˜¶æ®µ | çŠ¶æ€ | æ—¶é—´ | è¯´æ˜ | ç”¨æˆ·ä½“éªŒ |
|------|------|------|------|----------|
| **æ¥æ”¶** | `Received` | å³æ—¶ | RPC æ¥æ”¶å¹¶åˆæ­¥éªŒè¯æ ¼å¼ | äº¤æ˜“å“ˆå¸Œè¿”å› |
| **éªŒè¯** | `Validated` | <1s | ç­¾åã€nonceã€ä½™é¢ç­‰éªŒè¯ | ç­‰å¾…ç¡®è®¤ |
| **æ’é˜Ÿ** | `Queued` | 1-30s | è¿›å…¥ Mempool ç­‰å¾…æ’åº | å¾…å¤„ç†çŠ¶æ€ |
| **æ’åº** | `Sequenced` | 1-60s | Sequencer é€‰å…¥ Miniblock | å³å°†æ‰§è¡Œ |
| **æ‰§è¡Œ** | `Executing` | <1s | EraVM æ‰§è¡Œäº¤æ˜“é€»è¾‘ | å¤„ç†ä¸­ |
| **å®Œæˆ** | `Executed` | <1s | æ‰§è¡Œå®Œæˆï¼ŒçŠ¶æ€æ›´æ–° | æ‰§è¡Œç»“æœ |
| **åŒ…å«** | `Included` | 1-10s | å†™å…¥ Miniblock | **L2 ç¡®è®¤** |
| **æäº¤** | `Committed` | 1-10min | Batch æ•°æ®ä¸Šé“¾ | æ•°æ®å®‰å…¨ |
| **è¯æ˜** | `Proved` | 1-24h | ZK è¯æ˜éªŒè¯é€šè¿‡ | **å®‰å…¨ç¡®è®¤** |
| **æœ€ç»ˆ** | `Finalized` | 1-24h | L1 æ‰§è¡Œï¼Œä¸å¯å›æ»š | **æœ€ç»ˆç¡®è®¤** |

### 2.3 è·¨å±‚äº¤æ˜“å¤„ç†

#### ğŸ’° å­˜æ¬¾æµç¨‹ï¼ˆL1â†’L2ï¼‰

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant L1B as L1 Bridge
    participant L1AR as L1AssetRouter
    participant PQ as Priority Queue
    participant S as Sequencer
    participant L2 as L2 Account
    
    U->>L1B: è°ƒç”¨ deposit()
    L1B->>L1AR: è·¯ç”±å­˜æ¬¾è¯·æ±‚
    L1AR->>PQ: æ·»åŠ ä¼˜å…ˆäº¤æ˜“
    Note over PQ: ç­‰å¾… Sequencer å¤„ç†
    S->>PQ: è¯»å–ä¼˜å…ˆäº¤æ˜“
    S->>L2: æ‰§è¡Œå­˜æ¬¾äº¤æ˜“
    L2-->>U: èµ„é‡‘åˆ°è´¦
```

#### ğŸ’¸ ææ¬¾æµç¨‹ï¼ˆL2â†’L1ï¼‰

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant L2B as L2 Bridge
    participant L1M as L1Messenger
    participant L1 as L1 Contracts
    participant L1B as L1 Bridge
    
    U->>L2B: è°ƒç”¨ withdraw()
    L2B->>L1M: ç”Ÿæˆ L2â†’L1 æ¶ˆæ¯
    Note over L1M: æ¶ˆæ¯åŒ…å«åœ¨ Batch ä¸­
    Note over L1: Batch è¢«è¯æ˜å¹¶æ‰§è¡Œ
    U->>L1B: è°ƒç”¨ finalizeWithdrawal()
    L1B->>L1: éªŒè¯æ¶ˆæ¯è¯æ˜
    L1-->>U: èµ„é‡‘åˆ°è´¦
```

---

## ğŸ’° 3. è´¹ç”¨æ¨¡å‹

### 3.1 è´¹ç”¨ç»„æˆç»“æ„

zkSync Era é‡‡ç”¨åŒé‡è´¹ç”¨æ¨¡å‹ï¼ŒåŒ…å«æ‰§è¡Œè´¹ç”¨å’Œæ•°æ®è´¹ç”¨ï¼š

```mermaid
pie title äº¤æ˜“è´¹ç”¨æ„æˆ
    "æ‰§è¡Œè´¹ç”¨ (Gas)" : 60
    "æ•°æ®è´¹ç”¨ (Pubdata)" : 35
    "åè®®å¼€é”€" : 5
```

#### ğŸ§® è´¹ç”¨è®¡ç®—å…¬å¼

```text
TotalFee = ExecutionFee + PubdataFee + ProtocolOverhead

å…¶ä¸­ï¼š
ExecutionFee = gasUsed Ã— gasPrice
PubdataFee = pubdataBytes Ã— pubdataPrice
ProtocolOverhead = baseFee + priorityFee
```

### 3.2 æ‰§è¡Œè´¹ç”¨ï¼ˆGasï¼‰

> **æ³¨æ„**ï¼šzkSync Era ä½¿ç”¨æ ‡å‡†çš„ Gas è®¡é‡å•ä½ï¼Œä¸ä»¥å¤ªåŠå…¼å®¹ã€‚æ—©æœŸç‰ˆæœ¬æ›¾ä½¿ç”¨ "Ergs" æœ¯è¯­ï¼Œä½†ç°å·²ç»Ÿä¸€ä¸º Gasã€‚

#### âš¡ zkSync Era Gas vs Ethereum Gas å¯¹æ¯”

| æ–¹é¢ | zkSync Era Gas | Ethereum Gas |
|------|----------------|--------------|
| **è®¡é‡å•ä½** | gas | gas |
| **æ“ä½œæˆæœ¬** | åŸºäº EraVM æŒ‡ä»¤ä¼˜åŒ– | åŸºäº EVM æ“ä½œç  |
| **å­˜å‚¨è®¿é—®** | ä¼˜åŒ–çš„å­˜å‚¨æ¨¡å‹ | ä¼ ç»Ÿ SSTORE/SLOAD |
| **é¢„ç¼–è¯‘** | åŸç”Ÿ ZK å‹å¥½æ“ä½œ | æ ‡å‡†ä»¥å¤ªåŠé¢„ç¼–è¯‘ |
| **Gas é™åˆ¶** | 80,000,000 per tx | 30,000,000 per block |

#### ğŸ“Š å¸¸è§æ“ä½œçš„ Gas æ¶ˆè€—

| æ“ä½œç±»å‹ | Gas æ¶ˆè€— | è¯´æ˜ |
|----------|----------|------|
| **åŸºç¡€è½¬è´¦** | ~21,000 | ETH è½¬è´¦ |
| **ERC20 è½¬è´¦** | ~45,000 | ä»£å¸è½¬è´¦ |
| **åˆçº¦éƒ¨ç½²** | ~200,000+ | å–å†³äºåˆçº¦å¤§å° |
| **å­˜å‚¨å†™å…¥** | ~20,000 | æ¯ä¸ªå­˜å‚¨æ§½ |
| **å­˜å‚¨è¯»å–** | ~800 | æ¯æ¬¡è®¿é—® |
| **æ—¥å¿—ç”Ÿæˆ** | ~375/topic | æ¯ä¸ªæ—¥å¿—ä¸»é¢˜ |

### 3.3 æ•°æ®è´¹ç”¨ï¼ˆPubdataï¼‰

#### ğŸ“¡ Pubdata ç±»å‹ä¸æˆæœ¬

```mermaid
graph TD
    subgraph "Pubdata å‘å¸ƒæ–¹å¼"
        CD[Calldata<br/>~16 gas/byte]
        BLOB[EIP-4844 Blob<br/>~1 gas/byte]
    end
    
    subgraph "æ•°æ®ç±»å‹"
        SD[çŠ¶æ€å·®åˆ†<br/>State Diffs]
        LD[æ—¥å¿—æ•°æ®<br/>L2â†’L1 Logs]
        MD[æ¶ˆæ¯æ•°æ®<br/>Cross-layer Messages]
    end
    
    SD --> CD
    SD --> BLOB
    LD --> CD
    MD --> CD
    
    style BLOB fill:#e8f5e8
    style CD fill:#fff3e0
```

#### ğŸ’¡ è´¹ç”¨ä¼˜åŒ–ç­–ç•¥

| ç­–ç•¥ | æè¿° | èŠ‚çœå¹…åº¦ |
|------|------|----------|
| **çŠ¶æ€å‹ç¼©** | ä½¿ç”¨å·®åˆ†å‹ç¼©å‡å°‘ pubdata | 30-50% |
| **æ‰¹é‡æ“ä½œ** | èšåˆå¤šä¸ªæ“ä½œå‡å°‘å¼€é”€ | 20-40% |
| **EIP-4844 Blob** | ä½¿ç”¨ blob é™ä½æ•°æ®æˆæœ¬ | 90%+ |
| **å­˜å‚¨ä¼˜åŒ–** | å‡å°‘ä¸å¿…è¦çš„çŠ¶æ€å†™å…¥ | 10-30% |

### 3.4 åŠ¨æ€å®šä»·æœºåˆ¶

#### ğŸ“ˆ ä»·æ ¼è°ƒæ•´ç®—æ³•

```mermaid
graph LR
    subgraph "è¾“å…¥å› å­"
        L1G[L1 Gas ä»·æ ¼]
        L2L[L2 è´Ÿè½½]
        BU[Blob åˆ©ç”¨ç‡]
    end
    
    subgraph "å®šä»·å¼•æ“"
        PA[ä»·æ ¼ç®—æ³•]
    end
    
    subgraph "è¾“å‡ºä»·æ ¼"
        EP[Gas ä»·æ ¼]
        PP[Pubdata ä»·æ ¼]
    end
    
    L1G --> PA
    L2L --> PA
    BU --> PA
    PA --> EP
    PA --> PP
    
    style PA fill:#e3f2fd
```

#### ğŸ¯ Paymaster ä»£ä»˜æœºåˆ¶

**æ”¯æŒçš„ä»£ä»˜æ¨¡å¼**ï¼š

1. **é€šç”¨ä»£ä»˜**ï¼šåè®®æˆ– dApp ä¸ºç”¨æˆ·æ”¯ä»˜æ‰€æœ‰è´¹ç”¨
2. **ä»£å¸ä»£ä»˜**ï¼šç”¨æˆ·ç”¨ ERC20 ä»£å¸æ”¯ä»˜ï¼ŒPaymaster è½¬æ¢ä¸º ETH
3. **æ¡ä»¶ä»£ä»˜**ï¼šæ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶æä¾›ä»£ä»˜æœåŠ¡
4. **æ‰¹é‡ä»£ä»˜**ï¼šä¸ºæ‰¹é‡æ“ä½œæä¾›ä¼˜åŒ–çš„ä»£ä»˜æ–¹æ¡ˆ

```solidity
// Paymaster æ¥å£ç¤ºä¾‹
interface IPaymaster {
    function validateAndPayForPaymasterTransaction(
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        Transaction calldata _transaction
    ) external payable returns (bytes4 magic, bytes memory context);
    
    function postTransaction(
        bytes calldata _context,
        Transaction calldata _transaction,
        bytes32 _txHash,
        bytes32 _suggestedSignedHash,
        ExecutionResult _txResult,
        uint256 _maxRefundedGas
    ) external payable;
}
```

---

## ğŸ”’ 4. zkSync é“¾çš„æœ€ç»ˆæ€§

### 4.1 æœ€ç»ˆæ€§å±‚çº§

zkSync Era æä¾›å¤šå±‚æ¬¡çš„å®‰å…¨ä¿è¯ï¼Œæ»¡è¶³ä¸åŒåº”ç”¨åœºæ™¯çš„éœ€æ±‚ï¼š

```mermaid
graph TD
    subgraph "æœ€ç»ˆæ€§å±‚çº§"
        L2[L2 è½¯ç¡®è®¤<br/>~1-10ç§’<br/>ç”¨æˆ·ä½“éªŒä¼˜åŒ–]
        L1C[L1 æ‰¿è¯º<br/>~1-10åˆ†é’Ÿ<br/>æ•°æ®å¯ç”¨æ€§ä¿è¯]
        L1P[L1 è¯æ˜<br/>~1-24å°æ—¶<br/>å¯†ç å­¦å®‰å…¨ä¿è¯]
        L1E[L1 æ‰§è¡Œ<br/>~1-24å°æ—¶<br/>æœ€ç»ˆä¸å¯å›æ»š]
    end
    
    L2 --> L1C
    L1C --> L1P
    L1P --> L1E
    
    style L2 fill:#fff3e0
    style L1C fill:#e8f5e8
    style L1P fill:#e3f2fd
    style L1E fill:#fce4ec
```

### 4.2 å®‰å…¨ä¿è¯åˆ†æ

#### ğŸ›¡ï¸ å„å±‚çº§å®‰å…¨ç‰¹æ€§

| å±‚çº§ | å®‰å…¨å‡è®¾ | æ”»å‡»æˆæœ¬ | å›æ»šé£é™© | é€‚ç”¨åœºæ™¯ |
|------|----------|----------|----------|----------|
| **L2 è½¯ç¡®è®¤** | Sequencer è¯šå® | ä½ | ä¸­ç­‰ | å¿«é€Ÿäº¤äº’ã€æ¸¸æˆ |
| **L1 æ‰¿è¯º** | L1 å®‰å…¨ + æ•°æ®å¯ç”¨ | ä¸­ç­‰ | ä½ | ä¸€èˆ¬ DeFi æ“ä½œ |
| **L1 è¯æ˜** | å¯†ç å­¦å‡è®¾ | é«˜ | æä½ | å¤§é¢è½¬è´¦ |
| **L1 æ‰§è¡Œ** | L1 å…±è¯† | æé«˜ | æ—  | è·¨é“¾æ¡¥æ¥ã€ææ¬¾ |

#### ğŸ” é£é™©è¯„ä¼°

```mermaid
graph TD
    subgraph "å®‰å…¨æ€§ vs é€Ÿåº¦æƒè¡¡"
    A[L2è½¯ç¡®è®¤<br/>ä½å»¶è¿Ÿ-ä½å®‰å…¨] 
    B[L1æ‰¿è¯º<br/>ä¸­ç­‰å»¶è¿Ÿ-ä¸­ç­‰å®‰å…¨]
    C[L1è¯æ˜<br/>è¾ƒé«˜å»¶è¿Ÿ-é«˜å®‰å…¨]
    D[L1æ‰§è¡Œ<br/>é«˜å»¶è¿Ÿ-æœ€é«˜å®‰å…¨]
    end
```

### 4.3 æŠ—å®¡æŸ¥æœºåˆ¶

#### ğŸš« å®¡æŸ¥æ”»å‡»é˜²æŠ¤

**L1 ä¼˜å…ˆé˜Ÿåˆ—æœºåˆ¶**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant L1 as L1 åˆçº¦
    participant PQ as ä¼˜å…ˆé˜Ÿåˆ—
    participant S as Sequencer
    participant L2 as L2 ç½‘ç»œ
    
    Note over S: Sequencer å®¡æŸ¥ç”¨æˆ·äº¤æ˜“
    U->>L1: é€šè¿‡ L1 å¼ºåˆ¶åŒ…å«
    L1->>PQ: æ·»åŠ åˆ°ä¼˜å…ˆé˜Ÿåˆ—
    Note over PQ: ç­‰å¾…å¤„ç†ï¼ˆæœ€é•¿ ~24å°æ—¶ï¼‰
    S->>PQ: å¿…é¡»å¤„ç†ä¼˜å…ˆäº¤æ˜“
    S->>L2: æ‰§è¡Œå¼ºåˆ¶åŒ…å«çš„äº¤æ˜“
    L2-->>U: äº¤æ˜“æˆåŠŸæ‰§è¡Œ
```

**å…³é”®ç‰¹æ€§**ï¼š

- âœ… **å¼ºåˆ¶åŒ…å«**ï¼šç”¨æˆ·å¯é€šè¿‡ L1 å¼ºåˆ¶ Sequencer åŒ…å«äº¤æ˜“
- âœ… **æ—¶é—´ä¿è¯**ï¼šä¼˜å…ˆé˜Ÿåˆ—äº¤æ˜“å¿…é¡»åœ¨è§„å®šæ—¶é—´å†…å¤„ç†
- âœ… **è´¹ç”¨ä¿æŠ¤**ï¼šL1 è´¹ç”¨ç¡®ä¿ç»æµæ¿€åŠ±å¯¹é½
- âš ï¸ **å¤„ç†å»¶è¿Ÿ**ï¼šç›¸æ¯”æ­£å¸¸ L2 äº¤æ˜“æœ‰é¢å¤–å»¶è¿Ÿ

### 4.4 æ•°æ®å¯ç”¨æ€§ä¿è¯

#### ğŸ“Š çŠ¶æ€é‡å»ºæœºåˆ¶

ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡ L1 ä¸Šçš„ pubdata é‡å»ºå®Œæ•´çš„ L2 çŠ¶æ€ï¼š

```mermaid
flowchart LR
    subgraph "L1 æ•°æ®æº"
        CD[Calldata]
        BLOB[EIP-4844 Blob]
        LOGS[äº‹ä»¶æ—¥å¿—]
    end
    
    subgraph "é‡å»ºè¿‡ç¨‹"
        PD[è§£æ Pubdata]
        SD[åº”ç”¨çŠ¶æ€å·®åˆ†]
        VR[éªŒè¯æ ¹å“ˆå¸Œ]
    end
    
    subgraph "è¾“å‡ºç»“æœ"
        FS[å®Œæ•´ L2 çŠ¶æ€]
        TH[äº¤æ˜“å†å²]
        AB[è´¦æˆ·ä½™é¢]
    end
    
    CD --> PD
    BLOB --> PD
    LOGS --> PD
    PD --> SD
    SD --> VR
    VR --> FS
    VR --> TH
    VR --> AB
    
    style PD fill:#e3f2fd
    style FS fill:#c8e6c9
```

#### ğŸ”§ å®ç°ç»†èŠ‚

**Pubdata æ ¼å¼**ï¼š

```text
Batch Pubdata = {
    stateUpdates: StateUpdate[],     // çŠ¶æ€å˜æ›´
    l2ToL1Messages: Message[],       // L2â†’L1 æ¶ˆæ¯
    deployedContracts: Contract[],   // æ–°éƒ¨ç½²åˆçº¦
    usedL1ToL2Messages: Hash[]       // å·²å¤„ç† L1â†’L2 æ¶ˆæ¯
}
```

**éªŒè¯æµç¨‹**ï¼š

1. è§£æ pubdata è·å–çŠ¶æ€å˜æ›´
2. æŒ‰é¡ºåºåº”ç”¨æ‰€æœ‰å˜æ›´
3. è®¡ç®—æ–°çš„çŠ¶æ€æ ¹
4. ä¸é“¾ä¸Šæ‰¿è¯ºçš„çŠ¶æ€æ ¹å¯¹æ¯”éªŒè¯

---

## ğŸ“š æ€»ç»“ä¸æœ€ä½³å®è·µ

### ğŸ¯ å…³é”®è¦ç‚¹

1. **åŒå±‚æ¶æ„**ï¼šMiniblock æä¾›å¿«é€Ÿç¡®è®¤ï¼ŒBatch æä¾›å®‰å…¨ä¿è¯
2. **å¤šé‡è´¹ç”¨**ï¼šæ‰§è¡Œè´¹ç”¨ï¼ˆgasï¼‰+ æ•°æ®è´¹ç”¨ï¼ˆpubdataï¼‰çš„ç»„åˆæ¨¡å‹
3. **æ¸è¿›å®‰å…¨**ï¼šä» L2 è½¯ç¡®è®¤åˆ° L1 æœ€ç»ˆç¡®è®¤çš„å¤šå±‚æ¬¡ä¿è¯
4. **æŠ—å®¡æŸ¥æ€§**ï¼šL1 ä¼˜å…ˆé˜Ÿåˆ—ç¡®ä¿äº¤æ˜“æœ€ç»ˆå¯è¢«å¼ºåˆ¶åŒ…å«

### ğŸ’¡ å¼€å‘å»ºè®®

| åº”ç”¨ç±»å‹ | æ¨èç¡®è®¤çº§åˆ« | ç­‰å¾…æ—¶é—´ | å®‰å…¨çº§åˆ« |
|----------|--------------|----------|----------|
| **æ¸¸æˆ/ç¤¾äº¤** | L2 è½¯ç¡®è®¤ | 1-10ç§’ | åŸºç¡€ |
| **DeFi äº¤æ˜“** | L1 æ‰¿è¯º | 1-10åˆ†é’Ÿ | ä¸­ç­‰ |
| **å¤§é¢è½¬è´¦** | L1 è¯æ˜ | 1-24å°æ—¶ | é«˜ |
| **è·¨é“¾æ¡¥æ¥** | L1 æ‰§è¡Œ | 1-24å°æ—¶ | æœ€é«˜ |

### ğŸ”§ æ€§èƒ½ä¼˜åŒ–

- **æ‰¹é‡æ“ä½œ**ï¼šèšåˆå¤šä¸ªäº¤æ˜“å‡å°‘å•ç¬”å¼€é”€
- **çŠ¶æ€ä¼˜åŒ–**ï¼šå‡å°‘ä¸å¿…è¦çš„å­˜å‚¨å†™å…¥
- **Paymaster**ï¼šä¸ºç”¨æˆ·æä¾›æ›´å¥½çš„è´¹ç”¨ä½“éªŒ
- **EIP-4844**ï¼šåˆ©ç”¨ blob é™ä½æ•°æ®å‘å¸ƒæˆæœ¬

---

## ğŸ“š æŠ€æœ¯å®ç°ç»†èŠ‚

### ğŸ” å…³é”®é…ç½®å‚æ•°

åŸºäº zkSync Era å®é™…å®ç°çš„é‡è¦é…ç½®ï¼š

| å‚æ•° | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| `MAX_L2_TX_GAS_LIMIT` | 80,000,000 | å•ç¬”äº¤æ˜“æœ€å¤§ Gas é™åˆ¶ |
| `MAX_PUBDATA_PER_L1_BATCH` | 120,000 bytes | æ¯ä¸ª L1 æ‰¹æ¬¡æœ€å¤§ Pubdata |
| `transaction_slots` | 750 | æ¯ä¸ªæ‰¹æ¬¡æœ€å¤§äº¤æ˜“æ•°é‡ |
| `miniblock_commit_deadline_ms` | 2,000 ms | Miniblock åˆ›å»ºé—´éš” |

### ğŸ—ï¸ æ ¸å¿ƒæ•°æ®ç»“æ„

```solidity
// CommitBatchInfo å®Œæ•´ç»“æ„
struct CommitBatchInfo {
    uint64 batchNumber;
    uint64 timestamp;
    uint64 indexRepeatedStorageChanges;
    bytes32 newStateRoot;
    uint256 numberOfLayer1Txs;
    bytes32 priorityOperationsHash;
    bytes32 bootloaderHeapInitialContentsHash;
    bytes32 eventsQueueStateHash;
    bytes systemLogs;
    bytes totalL2ToL1Pubdata;
}
```

### ğŸ“– å‚è€ƒèµ„æ–™

- [zkSync Era å®˜æ–¹æ–‡æ¡£](https://docs.zksync.io/)
- [zkSync Era GitHub](https://github.com/matter-labs/zksync-era)
- [ValidatorTimelock åˆçº¦](https://github.com/matter-labs/era-contracts)
- [EIP-4844 Blob äº¤æ˜“](https://eips.ethereum.org/EIPS/eip-4844)

---

> ğŸ’¡ **ä¸‹ä¸€æ­¥é˜…è¯»**ï¼š[05_è¯æ˜ç³»ç»Ÿ](./05_è¯æ˜ç³»ç»Ÿ.md) - æ·±å…¥äº†è§£ zkSync Era çš„é›¶çŸ¥è¯†è¯æ˜ç”Ÿæˆä¸éªŒè¯æœºåˆ¶
