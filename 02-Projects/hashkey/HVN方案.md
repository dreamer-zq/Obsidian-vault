
# HVN（HSK Validation Network）方案汇报

## 一、引言（基础需求）

随着区块链技术的不断发展，Optimism 网络作为以太坊生态中的重要组成部分，也面临着诸如安全性、扩展性等方面的挑战。在现有的 Optimism 网络架构中，中心化的 Sequencer 存在着一定的潜在风险。Sequencer 负责交易的排序和区块的提议，一旦 Sequencer 出现故障或者被恶意操控，可能会导致非法区块的产生，进而引发 L2 重组等问题，这对用户的资产安全和网络的稳定性构成了重大威胁。

为了解决这些问题，我们提出了 HVN（HSK Validation Network）方案，通过引入共识网络，实现了区块构建验证过程与 Sequencer 执行引擎的分离。这种设计有效防止了因中心化 Sequencer 作恶而导致的非法区块和 L2 重组问题，增强了网络的安全性和可信度。同时，HVN 方案还具有良好的扩展性和可维护性，为 Optimism 网络的未来发展提供了坚实基础。目前，HVN 方案的 POC 验证已经成功完成，结果表明该方案在技术上是可行的，能够有效满足上述中心化Sequencer的问题。

## 二、方案概述

### （一）背景（op架构和简述）

![image-20250305155806512](/Users/yilong/Library/Application Support/typora-user-images/image-20250305155806512.png)

在现有的 Optimism 架构中，主要组件包括 op-batcher、op-proposer 、op-node 和 op-geth。

- **op-batcher**：负责将交易打包成批次并提交到L1链。
- **op-proposer**：负责提交状态根提议到L1链。
- **op-node**：主要作用是提议 L2 的区块和调用执行层的 op-geth。
- **op-geth**：作为 L2 的执行引擎，负责执行交易和维护 L2 的状态。
- **Sequencer**：运行 op-node 和 op-geth 的节点的逻辑身份。

现有的 Optimism 网络 Sequencer 作为交易排序器，掌握着对交易顺序的控制权，一旦 Sequencer 出现故障或被恶意操控，可能会导致非法区块的产生，进而引发 L2 重组等问题。这些问题不仅会破坏网络的稳定性，还可能对用户的资产安全造成威胁。因此，我们需要一种更加可靠和安全的机制来验证区块和交易，确保网络的正常运行。

### （二）目标

1. **增强网络安全性**：通过引入 VN 节点组成的共识网络，对 Sequencer 提议的区块进行验证，有效防止非法区块的产生，解决因 Sequencer 作恶导致的 L2 重组问题，保障用户资产安全和网络稳定性。
2. **提升网络扩展性**：将区块构建验证过程与 Sequencer 的执行引擎分离，使得网络能够更好地适配各种出块逻辑和交易排序，无需修改核心 Optimism 协议，为未来网络的扩展和优化提供灵活的支持。
3. **简化集成与维护**：采用插件化方式开发和维护 HVN 组件，尽量减少对现有 Optimism 架构和协议的修改，降低集成和维护的复杂性，同时确保系统架构的完整性和简洁性，便于后续的升级和调整。

### （三）概述

HVN 方案通过在 Optimism 系统中增加 VN 组件，形成了一种新型的网络架构。其中，VN 节点作为关键的组成部分，由多个功能各异的组件构成，包括 engine-proxy、local-geth 和 consensus 等。这些组件实现了对区块的创建、验证和执行共识等功能。具体而言，VN 节点接收 op-node 提议的 payload attribute，执行区块创建，并将其交付给 Sequencer 的 op-geth。同时，VN 节点还会将数据转发到共识组件，以确认参数的合法性，并调用 Sequencer 的 op-geth 创建并执行区块的请求。通过这种设计，HVN 方案在无需修改标准 Optimism 架构和协议的前提下，实现了对 Sequencer 的有效验证。

## 三、设计详情

### （一）架构设计

整体架构图如下：

![1](https://github.com/cyilong/test/raw/main/Optimism/25-3-4HVN.png)

在原有 Optimism 架构基础上，于 op-node 和 op-geth 之间增加了 HVN 的 VN 节点作为中介。VN 节点由多个组件构成，包括 engine-proxy、local-geth 和 consensus 等。具体来说，op-node 通过 engine API 调用创建区块接口，将区块提议发送给 VN 节点中的 engine-proxy 组件。engine-proxy 接收来自 op-node 的区块提议后，一方面将其打包成交易发送到共识层，另一方面将数据转发给 Sequencer 的 op-geth。在 VN 节点内部，local-geth 基于 op-geth 改造，用于共识节点本地执行区块并保存状态。consensus 组件则接收 local-geth 的区块提议，并在验证人节点之间进行通信，以保持状态一致性。通过这种架构设计，VN 节点实现了对区块的创建、验证和交付等功能，同时保证了与现有 Optimism 组件的兼容性。

### （二）组件设计

1. **VN 节点** ：VN 节点是 HVN 方案的核心组成部分，由 engine-proxy、local-geth 和 consensus 等多个组件构成。它作为 op-node 和 op-geth 之间的中介，负责接收 op-node 提议的 payload attribute，执行区块的创建，并将区块交付给 Sequencer 的 op-geth。同时，VN 节点还通过 consensus 组件实现了对区块的验证和共识过程。
2. **engine-proxy** ：engine-proxy 是 VN 节点的重要组件之一，它实现了标准的 engine API，用于接收来自 Sequencer 的 op-node 构造区块的请求。在接收到请求后，engine-proxy 将数据打包成交易发送到共识层，并同时将数据转发给 Sequencer 的 op-geth。此外，engine-proxy 还负责将 Sequencer 的 op-geth 执行完成后的数据返回给 Sequencer 的 op-node。
3. **local-geth** ：local-geth 是基于 op-geth 改造的组件，主要用于共识节点本地执行区块并保存状态。在 VN 节点中，local-geth 接收来自 engine-proxy 的区块提议，并在本地执行区块，以确保共识节点能够准确地验证区块的合法性和有效性。
4. **consensus** ：consensus 组件是 VN 节点中负责共识过程的关键部分。它接收来自 local-geth 的区块提议，并在验证人节点之间进行通信，以确保所有验证人节点能够达成共识，保持状态一致性。通过 consensus 组件，VN 节点能够有效地验证 Sequencer 提议的区块，防止非法区块的产生。

### （三）流程设计

整体流程图如下：

![2](https://github.com/cyilong/test/raw/main/Optimism/25-3-4consensus.jpg)

1. **区块创建流程** ：Sequencer 的 op-node 向 VN 节点的 engine-proxy 发送构造区块（ForkchoiceUpdated）和执行区块（NewPayload）数据。engine-proxy 接收数据后，将其打包成交易发送到共识层。同时，engine-proxy 将数据转发给 Sequencer 的 op-geth。
2. **区块验证流程** ：VN 节点中的 local-geth 接收来自 engine-proxy 的区块提议，并在本地执行区块。执行完成后，local-geth 将区块提议提交给 consensus 组件。consensus 组件在验证人节点之间进行通信，对区块提议进行验证和投票，以确保区块的合法性和有效性。
3. **区块交付流程** ：在 consensus 组件完成对区块提议的验证后，Sequencer 的 op-geth 执行完成，并将执行结果返回给 engine-proxy。engine-proxy 最终将数据返回给 Sequencer 的 op-node，完成整个区块的创建和交付流程。

## 四、POC 验证结果

### （一）功能验证

通过多次架构设计和流程改造的调整，最终 POC 验证通过功能性、效率和兼容性等方面。测试结果表明，VN 节点能够准确地接收 op-node 提议的 payload attribute，并执行区块的创建和交付。同时，consensus 组件能够在验证人节点之间实现有效的共识，确保验证区块中交易的合法性和有效性。HVN 方案可以解决因 Sequencer 作恶导致的区块问题，保障了网络的安全性和稳定性。

### （二）性能验证

性能测试结果表明，HVN 方案对 Optimism 网络的性能影响在可接受范围内。虽然在 node 和 geth 之间添加了一层逻辑，导致执行效率略有增加延迟，但通过异步处理等优化措施，已经有效地解决了这一问题。测试数据显示，区块生产时间、执行效率以及网络延迟等关键性能指标均达到了预期目标，与 POC 前相比没有明显的下降，确保了网络的高性能运行。

### （三）安全验证

安全测试结果表明，HVN 方案在身份验证和授权方面具有较高的安全性，包括 op-node 到 op-geth 之间的访问、consensus 和本地 geth 之间的访问都要通过加密访问。

## 五、下一步具体实现计划

### （一）开发计划

1. **确定详尽需求** ：目前只是对基础需求（不修改 Optimism 代码，增加共识确保 L1 状态已共识）完成 POC 验证，但之前提到但未确定的需求，例如：”验证节点激励计划、作恶处理等。“需列出详细需求描述。
1. **开发进度** ：根据完整需求制定详细的开发进度计划，可采用上限初版 + 快速迭代方式，确保项目按时完成。在每个周期末（时间待定）进行阶段性的信息同步，确保进度和质量。
1. **开发阶段** ：根据 POC 验证结果和完整需求，对 HVN 方案进行进一步的优化和完善。重点对 engine-proxy 架构和 consensus 等核心组件进行代码优化和功能增强，提高系统的性能和稳定性。

### （二）部署计划

1. **部署环境准备** ：在正式上线前，搭建与生产环境相似的测试环境，对 HVN 方案进行全面的测试和验证。确保测试环境的硬件配置、网络环境等与生产环境保持一致，以便及时发现和解决潜在的问题。
2. **节点部署和配置** ：根据网络拓扑结构，合理部署 VN 节点、op-node 和 op-geth 等节点。在部署过程中，严格按照操作手册进行配置，确保各个节点之间的通信和协同工作正常。
3. **数据迁移和备份** ：在切换到 HVN 方案前，对现有的 Optimism 网络数据进行全量备份。同时，制定详细的数据迁移计划，确保数据的完整性和一致性。

### （三）测试计划

1. **测试目标** ：全面测试 HVN 方案的功能、性能、安全性和兼容性，确保其能够满足 Optimism 网络的生产环境要求。
2. **测试范围** ：涵盖 HVN 方案的所有核心组件和功能模块，包括 engine-proxy、local-geth、consensus、区块创建、验证和交付等。
3. **测试方法** ：采用黑盒测试、白盒测试、性能测试、安全测试等多种测试方法，对 HVN 方案进行全面的测试。
4. **测试进度** ：制定详细的测试进度计划，确保测试工作按时完成。在每个周期末进行阶段性的测试总结和问题改进。

### （四）上线计划

1. **上线时间** ：根据开发和测试进度，确定 HVN 方案的正式上线时间。预计上线时间为【请填写：具体日期】。
2. **上线步骤** ：在上线前，制定详细的上线操作手册和应急预案。上线过程中，按照操作手册逐步进行节点切换和配置更新，确保上线过程的顺利进行。
3. **风险及应对措施** ：对上线过程中可能出现的风险进行全面评估，并制定相应的应对措施。例如，针对可能出现的节点故障、网络延迟等问题，提前准备好备用节点和网络优化方案。

## 六、可能遇到的问题及解决方法

### （一）数据状态一致性

1. **问题描述** ：因为现在生产网络 geth 已经运行一段时间，新加入网络的验证节点部署需遵循标准部署流程，否则会出现验证节点本地geth状态不一致等问题。
2. **解决方法** ：增加验证节点部署需遵循标准部署流程；验证节点在启动时候需要下载对应共识高度的 geth 状态数据。

### （二）安全风险

1. **问题描述** ：尽管在 POC 验证中，HVN 方案展现出了较高的安全性，但在实际应用中，仍可能面临黑客攻击、数据泄露等安全风险。特别是在新引入的共识网络可能是一个新的攻击点，需要加以保护。
2. **解决方法** ：加强网络安全防护，例如在验证人节点和`op-ndoe`之间的身份验证和授权方面。同时，建立完善的安全监控和预警机制，及时发现和处理安全事件。

### （三）兼容性问题

1. **问题描述** ： `op-node` 或 `op-geth` 依赖于特定的接口或行为，则未来的更新可能会影响其功能，从而产生兼容性问题。

## 七、结论

HVN 方案通过在 Optimism 架构中引入 VN 节点组成的共识网络，实现了区块构建验证过程与 Sequencer 执行引擎的分离，有效解决了因 Sequencer 作恶导致的非法区块和 L2 重组问题，显著提升了 Optimism 网络的安全性和稳定性。同时，该方案具有良好的扩展性和可维护性，为 Optimism 网络的未来发展提供了有力支持。在下一步的实施过程中，我们将按照详细的开发、部署、测试和上线计划，稳步推进 HVN 方案的正式应用，确保其能够为 Optimism 网络的长期稳定运行做出贡献。

## 八、附件

【相关技术文档、测试报告、代码示例等附件内容】
